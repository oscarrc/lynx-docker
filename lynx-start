#!/bin/bash

echo "LYNX DOCKER"
echo "----------------------------------------"
echo "Docker image by https://oscarrc.me"
echo "If you like it please consider donating:"
echo "https://ko-fi.com/oscarrc"
echo "----------------------------------------"

sleep 10

echo "SETTING CONFIGURATION"
echo "----------------------------------------"

configfile="/etc/lynx/lynx.conf"
datadir="$(grep -i "^ *datadir=" ${configfile} | cut -d '=' -f2)"

if [[ -f "${datadir}/lynx.conf" ]]; then
    datadir="$(grep -i "^ *datadir=" ${configfile} | cut -d '=' -f2)"
    configfile="${datadir}/lynx.conf"
else
    echo "No config file found. Starting Lynx with default config."
fi

echo "DONE."

echo "----------------------------------------"
echo "BOOTSTRAPING BLOCKCHAIN DATA"
echo "----------------------------------------"

isTestnet="$(grep -i "^ *testnet=1" ${configfile} | cut -d '=' -f2)"
chainstate="$(ls ${datadir}/chainstate 2> /dev/null | wc -l)"
blocks="$(ls ${datadir}/blocks 2> /dev/null | wc -l)"
currentDate="$(date +%F)"

if [[ isTestnet -eq 1 ]]; then
    echo "Testnet detected. Starting with testnet data."
    mkdir -p "$datadir/testnet"
    datadir="$datadir/testnet"
    chainstate="$(ls ${datadir}/chainstate | wc -l)"
    blocks="$(ls ${datadir}/blocks | wc -l)"
fi

if [[ $chainstate -le 0 ]]; then
    wget https://github.com/getlynx/LynxBootstrap/releases/download/v5.0-mainnet/chainstate.tar.gz -P /tmp -q --show-progress --progress=bar:force
    echo "Unpacking chain state..."
    tar -xzf /tmp/chainstate.tar.gz -C $datadir
fi

if [[ $blocks -le 0 ]]; then
    wget https://github.com/getlynx/LynxBootstrap/releases/download/v5.0-mainnet/blocks.tar.gz -P /tmp -q --show-progress --progress=bar:force
    echo "Unpacking blocks..."
    tar -xzf /tmp/blocks.tar.gz -C $datadir
fi

echo "DONE."

echo "----------------------------------------"
echo "STARTING LYNX"
echo "----------------------------------------"

[[ -f "${datadir}/debug.log" ]] || touch $datadir/debug.log
tail -f $datadir/debug.log &
echo "DONE. HAVE FUN!"
lynxd -conf=$configfile

echo "----------------------------------------"